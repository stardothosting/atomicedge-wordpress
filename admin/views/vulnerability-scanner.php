<?php
/**
 * Vulnerability Scanner Page View
 *
 * @package AtomicEdge
 */

// Prevent direct access.
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

$vuln_scanner      = AtomicEdge::get_instance()->vulnerability_scanner;
$vuln_last_scan    = $vuln_scanner->get_last_scan_time();
$vuln_last_results = $vuln_scanner->get_last_results();
$vuln_available    = $vuln_scanner->is_available();
?>
<div class="wrap atomicedge-wrap">
	<h1><img src="<?php echo esc_url( ATOMICEDGE_PLUGIN_URL . 'assets/images/logo.svg' ); ?>" alt="<?php esc_attr_e( 'Atomic Edge', 'atomicedge' ); ?>" class="atomicedge-logo" /></h1>

	<div class="atomicedge-vulnerability-scanner">
		<h2><?php esc_html_e( 'Vulnerability Scanner', 'atomicedge' ); ?></h2>
		<p class="atomicedge-page-description">
			<?php esc_html_e( 'Check your WordPress core, plugins, and themes against the Wordfence Intelligence vulnerability database for known security issues.', 'atomicedge' ); ?>
		</p>

		<?php if ( ! $vuln_available ) : ?>
			<div class="atomicedge-notice atomicedge-notice-info">
				<span class="dashicons dashicons-info"></span>
				<p>
					<?php
					printf(
						/* translators: %s: Settings page URL */
						esc_html__( 'Vulnerability scanning requires an Atomic Edge API connection. %s to enable this feature.', 'atomicedge' ),
						'<a href="' . esc_url( admin_url( 'admin.php?page=atomicedge-settings' ) ) . '">' . esc_html__( 'Connect in Settings', 'atomicedge' ) . '</a>'
					);
					?>
				</p>
			</div>
		<?php else : ?>
			<!-- Vulnerability Scanner Controls -->
			<div class="atomicedge-scanner-controls">
				<div class="atomicedge-scanner-info">
					<?php if ( $vuln_last_scan ) : ?>
						<p>
							<?php
							printf(
								/* translators: %s: last scan time */
								esc_html__( 'Last scan: %s', 'atomicedge' ),
								esc_html( $vuln_last_scan )
							);
							?>
						</p>
					<?php else : ?>
						<p><?php esc_html_e( 'No vulnerability scans have been run yet.', 'atomicedge' ); ?></p>
					<?php endif; ?>
				</div>

				<div class="atomicedge-scanner-actions">
					<button type="button" id="atomicedge-run-vuln-scan" class="button button-primary button-hero">
						<span class="dashicons dashicons-shield"></span>
						<?php esc_html_e( 'Check Vulnerabilities', 'atomicedge' ); ?>
					</button>
					<button type="button" id="atomicedge-reset-vuln-results" class="button" <?php echo empty( $vuln_last_results ) ? 'disabled' : ''; ?>>
						<span class="dashicons dashicons-trash"></span>
						<?php esc_html_e( 'Reset Results', 'atomicedge' ); ?>
					</button>
				</div>
			</div>

			<!-- Vulnerability Scan Progress -->
			<div id="atomicedge-vuln-progress" class="atomicedge-scan-progress" style="display: none;">
				<div class="atomicedge-progress-bar">
					<div class="atomicedge-progress-fill"></div>
				</div>
				<p class="atomicedge-progress-text"><?php esc_html_e( 'Checking for vulnerabilities...', 'atomicedge' ); ?></p>
			</div>

			<!-- Vulnerability Results -->
			<div id="atomicedge-vuln-results" class="atomicedge-scan-results">
				<?php if ( ! empty( $vuln_last_results ) ) : ?>
					<?php
					$wordpress_vulns = $vuln_last_results['wordpress']['vulnerabilities'] ?? array();
					$plugin_vulns    = array();
					$theme_vulns     = array();
					$total_vulns     = count( $wordpress_vulns );

					foreach ( $vuln_last_results['plugins'] ?? array() as $plugin ) {
						if ( ! empty( $plugin['vulnerabilities'] ) ) {
							$plugin_vulns[ $plugin['name'] ] = $plugin;
							$total_vulns                    += count( $plugin['vulnerabilities'] );
						}
					}

					foreach ( $vuln_last_results['themes'] ?? array() as $theme ) {
						if ( ! empty( $theme['vulnerabilities'] ) ) {
							$theme_vulns[ $theme['name'] ] = $theme;
							$total_vulns                  += count( $theme['vulnerabilities'] );
						}
					}
					?>

					<!-- Vulnerability Summary -->
					<div class="atomicedge-results-summary">
						<h3><?php esc_html_e( 'Scan Results', 'atomicedge' ); ?></h3>
						<div class="atomicedge-summary-grid">
							<a href="#vuln-section-wordpress" class="atomicedge-summary-item <?php echo empty( $wordpress_vulns ) ? 'atomicedge-ok' : 'atomicedge-critical'; ?>">
								<span class="dashicons <?php echo empty( $wordpress_vulns ) ? 'dashicons-yes-alt' : 'dashicons-dismiss'; ?>"></span>
								<span class="atomicedge-summary-count"><?php echo esc_html( count( $wordpress_vulns ) ); ?></span>
								<span class="atomicedge-summary-label"><?php esc_html_e( 'WordPress Core', 'atomicedge' ); ?></span>
							</a>
							<a href="#vuln-section-plugins" class="atomicedge-summary-item <?php echo empty( $plugin_vulns ) ? 'atomicedge-ok' : 'atomicedge-critical'; ?>">
								<span class="dashicons <?php echo empty( $plugin_vulns ) ? 'dashicons-yes-alt' : 'dashicons-dismiss'; ?>"></span>
								<span class="atomicedge-summary-count"><?php echo esc_html( array_sum( array_map( function( $p ) { return count( $p['vulnerabilities'] ); }, $plugin_vulns ) ) ); ?></span>
								<span class="atomicedge-summary-label"><?php esc_html_e( 'Plugin Vulnerabilities', 'atomicedge' ); ?></span>
							</a>
							<a href="#vuln-section-themes" class="atomicedge-summary-item <?php echo empty( $theme_vulns ) ? 'atomicedge-ok' : 'atomicedge-warning'; ?>">
								<span class="dashicons <?php echo empty( $theme_vulns ) ? 'dashicons-yes-alt' : 'dashicons-warning'; ?>"></span>
								<span class="atomicedge-summary-count"><?php echo esc_html( array_sum( array_map( function( $t ) { return count( $t['vulnerabilities'] ); }, $theme_vulns ) ) ); ?></span>
								<span class="atomicedge-summary-label"><?php esc_html_e( 'Theme Vulnerabilities', 'atomicedge' ); ?></span>
							</a>
						</div>
					</div>

					<!-- Severity Filters -->
					<div class="atomicedge-vuln-filters">
						<strong><?php esc_html_e( 'Filter by severity:', 'atomicedge' ); ?></strong>
						<label><input type="checkbox" class="atomicedge-vuln-filter" value="critical" checked> <?php esc_html_e( 'Critical', 'atomicedge' ); ?></label>
						<label><input type="checkbox" class="atomicedge-vuln-filter" value="high" checked> <?php esc_html_e( 'High', 'atomicedge' ); ?></label>
						<label><input type="checkbox" class="atomicedge-vuln-filter" value="medium" checked> <?php esc_html_e( 'Medium', 'atomicedge' ); ?></label>
						<label><input type="checkbox" class="atomicedge-vuln-filter" value="low" checked> <?php esc_html_e( 'Low', 'atomicedge' ); ?></label>
					</div>

					<!-- WordPress Core Vulnerabilities -->
					<?php if ( ! empty( $wordpress_vulns ) ) : ?>
						<div id="vuln-section-wordpress" class="atomicedge-results-section">
							<h3>
								<?php esc_html_e( 'WordPress Core Vulnerabilities', 'atomicedge' ); ?>
								<span class="atomicedge-results-count">(<?php echo esc_html( count( $wordpress_vulns ) ); ?>)</span>
							</h3>
							<p class="description">
								<?php
								printf(
									/* translators: %s: WordPress version */
									esc_html__( 'Your WordPress version (%s) has known vulnerabilities. Update to the latest version immediately.', 'atomicedge' ),
									esc_html( $vuln_last_results['wordpress']['version'] ?? '' )
								);
								?>
							</p>
							<?php foreach ( $wordpress_vulns as $vuln ) : ?>
								<div class="atomicedge-vuln-item atomicedge-severity-<?php echo esc_attr( $vuln['severity'] ?? 'medium' ); ?>">
									<div class="atomicedge-vuln-header">
										<span class="atomicedge-severity atomicedge-severity-<?php echo esc_attr( $vuln['severity'] ?? 'medium' ); ?>">
											<?php echo esc_html( ucfirst( $vuln['severity'] ?? 'medium' ) ); ?>
										</span>
										<strong><?php echo esc_html( $vuln['title'] ?? __( 'Unknown Vulnerability', 'atomicedge' ) ); ?></strong>
									</div>
									<?php if ( ! empty( $vuln['fixed_in'] ) ) : ?>
										<p class="atomicedge-vuln-fix">
											<?php
											printf(
												/* translators: %s: version number */
												esc_html__( 'Fixed in version: %s', 'atomicedge' ),
												esc_html( $vuln['fixed_in'] )
											);
											?>
										</p>
									<?php endif; ?>
									<p class="atomicedge-vuln-refs">
										<?php if ( ! empty( $vuln['id'] ) ) : ?>
											<a href="<?php echo esc_url( 'https://www.wordfence.com/threat-intel/vulnerabilities/id/' . $vuln['id'] ); ?>" target="_blank" rel="noopener noreferrer" class="atomicedge-vuln-link">
												<span class="dashicons dashicons-external"></span>
												<?php esc_html_e( 'More Info', 'atomicedge' ); ?>
											</a>
										<?php endif; ?>
										<?php if ( ! empty( $vuln['cve'] ) ) : ?>
											<a href="<?php echo esc_url( $vuln['cve_link'] ?? 'https://www.cve.org/CVERecord?id=' . $vuln['cve'] ); ?>" target="_blank" rel="noopener noreferrer" class="atomicedge-vuln-link atomicedge-cve-link">
												<?php echo esc_html( $vuln['cve'] ); ?>
											</a>
										<?php endif; ?>
									</p>
								</div>
							<?php endforeach; ?>
						</div>
					<?php endif; ?>

					<!-- Plugin Vulnerabilities -->
					<?php if ( ! empty( $plugin_vulns ) ) : ?>
						<div id="vuln-section-plugins" class="atomicedge-results-section" data-paginate="true" data-per-page="10">
							<h3>
								<?php esc_html_e( 'Vulnerable Plugins', 'atomicedge' ); ?>
								<span class="atomicedge-results-count">(<?php echo esc_html( count( $plugin_vulns ) ); ?>)</span>
							</h3>
							<?php foreach ( $plugin_vulns as $slug => $plugin ) : ?>
								<div class="atomicedge-vuln-plugin">
									<h4>
										<?php echo esc_html( $plugin['name'] ); ?>
										<span class="atomicedge-version"><?php echo esc_html( 'v' . ( $plugin['version'] ?? '?' ) ); ?></span>
									</h4>
									<?php foreach ( $plugin['vulnerabilities'] as $vuln ) : ?>
										<div class="atomicedge-vuln-item atomicedge-severity-<?php echo esc_attr( $vuln['severity'] ?? 'medium' ); ?>">
											<div class="atomicedge-vuln-header">
												<span class="atomicedge-severity atomicedge-severity-<?php echo esc_attr( $vuln['severity'] ?? 'medium' ); ?>">
													<?php echo esc_html( ucfirst( $vuln['severity'] ?? 'medium' ) ); ?>
												</span>
												<strong><?php echo esc_html( $vuln['title'] ?? __( 'Unknown Vulnerability', 'atomicedge' ) ); ?></strong>
											</div>
											<?php if ( ! empty( $vuln['fixed_in'] ) ) : ?>
												<p class="atomicedge-vuln-fix">
													<?php
													printf(
														/* translators: %s: version number */
														esc_html__( 'Fixed in version: %s', 'atomicedge' ),
														esc_html( $vuln['fixed_in'] )
													);
													?>
												</p>
											<?php endif; ?>
											<p class="atomicedge-vuln-refs">
												<?php if ( ! empty( $vuln['id'] ) ) : ?>
													<a href="<?php echo esc_url( 'https://www.wordfence.com/threat-intel/vulnerabilities/id/' . $vuln['id'] ); ?>" target="_blank" rel="noopener noreferrer" class="atomicedge-vuln-link">
														<span class="dashicons dashicons-external"></span>
														<?php esc_html_e( 'More Info', 'atomicedge' ); ?>
													</a>
												<?php endif; ?>
												<?php if ( ! empty( $vuln['cve'] ) ) : ?>
													<a href="<?php echo esc_url( $vuln['cve_link'] ?? 'https://www.cve.org/CVERecord?id=' . $vuln['cve'] ); ?>" target="_blank" rel="noopener noreferrer" class="atomicedge-vuln-link atomicedge-cve-link">
														<?php echo esc_html( $vuln['cve'] ); ?>
													</a>
												<?php endif; ?>
											</p>
										</div>
									<?php endforeach; ?>
								</div>
							<?php endforeach; ?>
							<div class="atomicedge-pagination"></div>
						</div>
					<?php endif; ?>

					<!-- Theme Vulnerabilities -->
					<?php if ( ! empty( $theme_vulns ) ) : ?>
						<div id="vuln-section-themes" class="atomicedge-results-section">
							<h3>
								<?php esc_html_e( 'Vulnerable Themes', 'atomicedge' ); ?>
								<span class="atomicedge-results-count">(<?php echo esc_html( count( $theme_vulns ) ); ?>)</span>
							</h3>
							<?php foreach ( $theme_vulns as $slug => $theme ) : ?>
								<div class="atomicedge-vuln-theme">
									<h4>
										<?php echo esc_html( $theme['name'] ); ?>
										<span class="atomicedge-version"><?php echo esc_html( 'v' . ( $theme['version'] ?? '?' ) ); ?></span>
									</h4>
									<?php foreach ( $theme['vulnerabilities'] as $vuln ) : ?>
										<div class="atomicedge-vuln-item atomicedge-severity-<?php echo esc_attr( $vuln['severity'] ?? 'medium' ); ?>">
											<div class="atomicedge-vuln-header">
												<span class="atomicedge-severity atomicedge-severity-<?php echo esc_attr( $vuln['severity'] ?? 'medium' ); ?>">
													<?php echo esc_html( ucfirst( $vuln['severity'] ?? 'medium' ) ); ?>
												</span>
												<strong><?php echo esc_html( $vuln['title'] ?? __( 'Unknown Vulnerability', 'atomicedge' ) ); ?></strong>
											</div>
											<?php if ( ! empty( $vuln['fixed_in'] ) ) : ?>
												<p class="atomicedge-vuln-fix">
													<?php
													printf(
														/* translators: %s: version number */
														esc_html__( 'Fixed in version: %s', 'atomicedge' ),
														esc_html( $vuln['fixed_in'] )
													);
													?>
												</p>
											<?php endif; ?>
											<p class="atomicedge-vuln-refs">
												<?php if ( ! empty( $vuln['id'] ) ) : ?>
													<a href="<?php echo esc_url( 'https://www.wordfence.com/threat-intel/vulnerabilities/id/' . $vuln['id'] ); ?>" target="_blank" rel="noopener noreferrer" class="atomicedge-vuln-link">
														<span class="dashicons dashicons-external"></span>
														<?php esc_html_e( 'More Info', 'atomicedge' ); ?>
													</a>
												<?php endif; ?>
												<?php if ( ! empty( $vuln['cve'] ) ) : ?>
													<a href="<?php echo esc_url( $vuln['cve_link'] ?? 'https://www.cve.org/CVERecord?id=' . $vuln['cve'] ); ?>" target="_blank" rel="noopener noreferrer" class="atomicedge-vuln-link atomicedge-cve-link">
														<?php echo esc_html( $vuln['cve'] ); ?>
													</a>
												<?php endif; ?>
											</p>
										</div>
									<?php endforeach; ?>
								</div>
							<?php endforeach; ?>
						</div>
					<?php endif; ?>

					<!-- All Clear -->
					<?php if ( 0 === $total_vulns ) : ?>
						<div class="atomicedge-all-clear">
							<span class="dashicons dashicons-shield-alt"></span>
							<h3><?php esc_html_e( 'No Known Vulnerabilities!', 'atomicedge' ); ?></h3>
							<p><?php esc_html_e( 'Your WordPress core, plugins, and themes have no known vulnerabilities.', 'atomicedge' ); ?></p>
						</div>
					<?php endif; ?>

				<?php else : ?>
					<div class="atomicedge-no-results">
						<span class="dashicons dashicons-shield"></span>
						<h3><?php esc_html_e( 'No Vulnerability Scan Yet', 'atomicedge' ); ?></h3>
						<p><?php esc_html_e( 'Click "Check Vulnerabilities" to scan your plugins and themes against the Wordfence Intelligence vulnerability database.', 'atomicedge' ); ?></p>
					</div>
				<?php endif; ?>
			</div>
		<?php endif; ?>

		<!-- What We Check -->
		<div class="atomicedge-scanner-info-box">
			<h3><?php esc_html_e( 'What We Check', 'atomicedge' ); ?></h3>
			<ul>
				<li>
					<span class="dashicons dashicons-yes"></span>
					<?php esc_html_e( 'WordPress core version against known CVEs', 'atomicedge' ); ?>
				</li>
				<li>
					<span class="dashicons dashicons-yes"></span>
					<?php esc_html_e( 'All installed plugins for security vulnerabilities', 'atomicedge' ); ?>
				</li>
				<li>
					<span class="dashicons dashicons-yes"></span>
					<?php esc_html_e( 'All installed themes for security vulnerabilities', 'atomicedge' ); ?>
				</li>
				<li>
					<span class="dashicons dashicons-yes"></span>
					<?php esc_html_e( 'Version-specific vulnerability filtering', 'atomicedge' ); ?>
				</li>
			</ul>
		</div>
	</div>
</div>
